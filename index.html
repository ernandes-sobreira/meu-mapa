<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mapa Cient√≠fico Colaborativo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
    margin:0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: linear-gradient(135deg,#0f172a,#075985);
}

/* TOPO */
header{
    background:white;
    text-align:center;
    padding:16px 10px;
    box-shadow:0 4px 14px rgba(0,0,0,0.2);
}

header h1{
    margin:0;
    font-size:26px;
}
header p{
    margin:6px 0 4px 0;
    color:#334155;
    max-width:800px;
    margin-left:auto;
    margin-right:auto;
    font-size:14px;
}

.badges{
    margin-top:6px;
}
.badge{
    display:inline-block;
    background:#e0f2fe;
    color:#075985;
    padding:4px 10px;
    border-radius:20px;
    margin:2px;
    font-size:11px;
}

/* LAYOUT */
#layout{
    display:flex;
    height:calc(100vh - 135px);
    -webkit-font-smoothing: antialiased;
}

#map{
    flex:2.3;
}

/* LATERAL */
#sidebar{
    flex:1;
    background:#f8fafc;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:12px;
    border-left:4px solid #0369a1;
}

/* PAIN√âIS */
.panel{
    background:white;
    border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,0.15);
    padding:10px;
    display:flex;
    flex-direction:column;
    min-height:0;
}

.panel h3{
    margin:4px 0 6px 0;
    font-size:15px;
}

/* INFO */
.subtitle{
    font-size:11px;
    color:#64748b;
    margin-bottom:4px;
}

/* MENSAGENS */
.messages{
    border:1px solid #e5e7eb;
    border-radius:6px;
    padding:6px;
    height:160px;
    overflow-y:auto;
    background:#f1f5f9;
    font-size:13px;
}

/* ENTRADA */
.controls{
    margin-top:6px;
    display:flex;
    gap:5px;
}
.controls input{
    padding:6px;
    font-size:13px;
    flex:1;
}

button{
    background:#0369a1;
    color:white;
    border:none;
    padding:7px 10px;
    border-radius:6px;
    cursor:pointer;
}

button:hover{
    background:#075985;
}

/* RESPONSIVO */
@media(max-width:900px){
    #layout{flex-direction:column;}
    #map{height:45vh;}
}

</style>
</head>

<body>

<header>
  <h1>üß≠ Mapa Cient√≠fico Colaborativo da Regi√£o</h1>
  <p>
    Plataforma aberta para registrar <strong>pesquisas em andamento</strong>,
    grupos de estudo, expedi√ß√µes de campo, monitoramentos ambientais e projetos
    cient√≠ficos no territ√≥rio do Pantanal, Cerrado e Amaz√¥nia.
  </p>
  <div class="badges">
    <span class="badge">üß™ Pesquisa de campo</span>
    <span class="badge">üåé Mapeamento territorial</span>
    <span class="badge">ü§ù Ci√™ncia colaborativa</span>
  </div>
</header>

<div id="layout">

  <div id="map"></div>

  <div id="sidebar">

    <!-- CHAT DO PIN -->
    <div class="panel">
      <h3>üí¨ Conversa do ponto</h3>
      <div class="subtitle" id="pin-title">
        Clique em um pin no mapa para conversar sobre aquela pesquisa.
      </div>

      <div class="messages" id="messages"></div>

      <div class="controls">
        <input id="nome" placeholder="Seu nome">
        <input id="msg" placeholder="Mensagem">
        <button onclick="sendMessage()">Enviar</button>
      </div>
    </div>

    <!-- CHAT GERAL -->
    <div class="panel">
      <h3>üåê Chat geral da comunidade</h3>
      <div class="subtitle">
        Espa√ßo geral para avisos de eventos, chamadas de reuni√£o,
        d√∫vidas coletivas e articula√ß√µes entre projetos.
      </div>

      <div class="messages" id="global-messages"></div>

      <div class="controls">
        <input id="g-nome" placeholder="Seu nome">
        <input id="g-msg" placeholder="Mensagem">
        <button onclick="sendGlobal()">Enviar</button>
        <button onclick="loadGlobal()">Atualizar</button>
      </div>
    </div>

  </div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwCutn7t2piEqfqk_I1RvjostsIWBojIFkQfWIGS1vMryFLAILqpIl44kXxMmxWHMIN/exec";

const map = L.map('map').setView([-15.6,-56.1],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);

let currentPinId = null;

loadPins();
loadGlobal();

map.on('click', async e=>{
  const nome = prompt("Seu nome:");
  if(!nome) return;

  const titulo = prompt("T√≠tulo da pesquisa nesse local:");
  if(!titulo) return;

  const body = new URLSearchParams({
    action:"addPin",
    lat:e.latlng.lat,
    lng:e.latlng.lng,
    nome,
    titulo,
    mensagem:""
  });

  const r = await fetch(API_URL,{method:"POST",body});
  const pin = await r.json();
  addMarker(pin);
});

async function loadPins(){
  const r = await fetch(API_URL+"?action=listPins");
  const d = await r.json();
  d.pins.forEach(addMarker);
}

function addMarker(pin){
  const m=L.marker([pin.lat,pin.lng]).addTo(map);
  m.bindPopup("<b>"+pin.titulo+"</b><br>por "+pin.nome);
  m.on("click",()=>openChat(pin));
}

async function openChat(pin){
  currentPinId=pin.id;
  document.getElementById("pin-title").innerText =
    pin.titulo + " ‚Äî " + pin.nome;

  const r=await fetch(API_URL+"?action=getComments&pinId="+pin.id);
  const d=await r.json();

  const box=document.getElementById("messages");
  box.innerHTML="";
  d.comments.forEach(c=>{
      box.innerHTML +=
        "<b>"+c.nome+"</b> "+new Date(c.createdAt).toLocaleString()+
        "<br>"+c.mensagem+"<hr>";
  });
  box.scrollTop=box.scrollHeight;
}

async function sendMessage(){
  if(!currentPinId){
    alert("Selecione um ponto no mapa primeiro.");
    return;
  }

  const nome=document.getElementById("nome").value.trim();
  const msg=document.getElementById("msg").value.trim();

  if(!nome||!msg)return;

  const body=new URLSearchParams({
    action:"addComment",
    pinId:currentPinId,
    nome,
    mensagem:msg
  });

  await fetch(API_URL,{method:"POST",body});
  document.getElementById("msg").value="";
  openChat({id:currentPinId,titulo:"",nome:""});
}

async function loadGlobal(){
  const r=await fetch(API_URL+"?action=getGlobal");
  const d=await r.json();

  const box=document.getElementById("global-messages");
  box.innerHTML="";

  d.messages.forEach(c=>{
    box.innerHTML +=
      "<b>"+c.nome+"</b> "+new Date(c.createdAt).toLocaleString()+
      "<br>"+c.mensagem+"<hr>";
  });

  box.scrollTop=box.scrollHeight;
}

async function sendGlobal(){
  const nome=document.getElementById("g-nome").value.trim();
  const msg=document.getElementById("g-msg").value.trim();

  if(!nome||!msg)return;

  const body=new URLSearchParams({
    action:"addGlobal",
    nome,
    mensagem:msg
  });

  await fetch(API_URL,{method:"POST",body});

  document.getElementById("g-msg").value="";
  loadGlobal();
}
</script>

</body>
</html>
