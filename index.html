<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Meu Mapa Colaborativo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
*{
  box-sizing:border-box;
}
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f2f4f7;
}

/* TOPO */
header{
  text-align:center;
  padding:8px 4px 4px 4px;
  background:#ffffff;
  box-shadow:0 1px 3px rgba(0,0,0,0.1);
  position:relative;
  z-index:10;
}
header h1{
  margin:0;
  font-size:22px;
}
header p{
  margin:4px 0 6px 0;
  font-size:12px;
  color:#555;
}

/* LAYOUT GERAL: MAPA + LATERAL */
#layout{
  display:flex;
  height:calc(100vh - 70px); /* tela inteira menos o cabe√ßalho */
}

/* MAPA √Ä ESQUERDA */
#map{
  flex:2;
}

/* LATERAL √Ä DIREITA */
#sidebar{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:10px;
  gap:10px;
  background:#f9fafb;
  border-left:1px solid #dde1e7;
}

/* CART√ïES DE CHAT */
.panel{
  background:#ffffff;
  border-radius:8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
  padding:8px 10px;
  display:flex;
  flex-direction:column;
  height:50%;
  min-height:0;
}

.panel h3{
  margin:4px 0 6px 0;
  font-size:16px;
}

.subtitle{
  font-size:11px;
  color:#666;
  margin-bottom:6px;
}

/* √ÅREAS DE MENSAGENS */
#messages, #global-messages{
  border:1px solid #e1e5eb;
  border-radius:6px;
  padding:6px;
  margin-bottom:6px;
  flex:1;
  overflow-y:auto;
  background:#fcfcff;
}

.msg-block{
  border-bottom:1px solid #eee;
  margin-bottom:4px;
  padding-bottom:4px;
  font-size:12px;
}
.msg-block:last-child{
  border-bottom:none;
}
.msg-block img{
  max-width:100%;
  max-height:160px;
  border-radius:6px;
  margin-top:4px;
}

/* CAMPOS E BOT√ïES */
input, button{
  padding:6px;
  font-size:12px;
}
.controls, .global-controls{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.controls input, .global-controls input{
  flex:1;
  min-width:0;
}
button{
  border:none;
  border-radius:4px;
  background:#2563eb;
  color:white;
  cursor:pointer;
  padding:6px 10px;
  white-space:nowrap;
}
button:hover{
  background:#1d4ed8;
}

/* RESPONSIVO: EM TELAS MUITO ESTREITAS, FICA EMPILHADO */
@media (max-width:900px){
  #layout{
    flex-direction:column;
  }
  #map{
    height:45vh;
  }
  #sidebar{
    height:55vh;
    border-left:none;
    border-top:1px solid #dde1e7;
  }
  .panel{
    height:50%;
  }
}
</style>
</head>

<body>

<header>
  <h1>üåç Meu Mapa Colaborativo</h1>
  <p>Clique no mapa para criar um pin. Clique em um pin para abrir o chat daquele local.  
     Para imagens, cole o link (ex: PNG/JPG). Imagens aparecem dentro da mensagem.</p>
</header>

<div id="layout">
  <div id="map"></div>

  <div id="sidebar">
    <!-- CHAT DO PONTO -->
    <div id="pin-chat" class="panel">
      <h3 id="chat-title">üí¨ Chat do ponto</h3>
      <div class="subtitle" id="chat-subtitle">
        Nenhum ponto selecionado. Clique em um pin no mapa.
      </div>
      <div id="messages"></div>
      
      <div class="controls">
        <input id="nome" placeholder="Seu nome">
        <input id="msg" placeholder="Mensagem">
        <input id="link" placeholder="Link de imagem/arquivo (opcional)">
        <button onclick="sendMessage()">Enviar</button>
      </div>
    </div>

    <!-- CHAT GERAL -->
    <div id="global-chat" class="panel">
      <h3>üåê Chat geral</h3>
      <div class="subtitle">
        Espa√ßo aberto para todos. Links de imagem aparecem dentro da mensagem.
      </div>
      <div id="global-messages"></div>
      <div class="global-controls">
        <input id="g-nome" placeholder="Seu nome">
        <input id="g-msg" placeholder="Mensagem">
        <input id="g-link" placeholder="Link de imagem/arquivo (opcional)">
        <button onclick="sendGlobal()">Enviar</button>
        <button onclick="loadGlobal()">Atualizar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwkwHwzC8ixl1CuNd9vKMQhlU54iGWR2V9nIY7p37oD5-nLJmAC6sn71TXScw9Q1A-X/exec";

const map = L.map('map').setView([-15.6,-56.1],4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18
}).addTo(map);

let currentPinId = null;

// carrega pins e chat geral ao abrir
loadPins();
loadGlobal();

/* ---------- MAPA E PINS ---------- */

map.on('click', async function(e){
  const nome = prompt("Seu nome:");
  if(!nome) return;

  const titulo = prompt("T√≠tulo do ponto:");
  if(!titulo) return;

  const mensagem = prompt("Mensagem inicial (opcional):") || "";

  const body = new URLSearchParams({
    action: 'addPin',
    lat: e.latlng.lat,
    lng: e.latlng.lng,
    nome,
    titulo,
    mensagem
  });

  const r = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  const pin = await r.json();
  addMarker(pin);
});

async function loadPins(){
  const r = await fetch(API_URL + "?action=listPins");
  const data = await r.json();
  (data.pins || []).forEach(addMarker);
}

function addMarker(pin){
  const m = L.marker([pin.lat, pin.lng]).addTo(map);
  m.bindPopup(`<b>${pin.titulo}</b><br>por ${pin.nome}<br><small>Clique para abrir o chat</small>`);
  m.on("click", ()=> openChat(pin));
}

/* ---------- CHAT DO PIN ---------- */

async function openChat(pin){
  currentPinId = pin.id;
  document.getElementById("chat-title").innerText =
    "üí¨ " + pin.titulo + " ‚Äî " + pin.nome;
  document.getElementById("chat-subtitle").innerText =
    "Conversando neste ponto. Todos veem esse chat ao clicar neste pin.";
  await loadComments(pin.id);
}

async function loadComments(pinId){
  const r = await fetch(API_URL + "?action=getComments&pinId=" + encodeURIComponent(pinId));
  const data = await r.json();

  const box = document.getElementById("messages");
  box.innerHTML = "";

  (data.comments || []).forEach(c => {
    const div = document.createElement("div");
    const dt = new Date(c.createdAt);

    div.className = "msg-block";

    let mediaHtml = "";
    if (c.fileUrl) {
      const clean = c.fileUrl.split("?")[0].toLowerCase();
      if (clean.endsWith(".png") || clean.endsWith(".jpg") || clean.endsWith(".jpeg") ||
          clean.endsWith(".gif") || clean.endsWith(".webp")) {
        mediaHtml = `<br><img src="${c.fileUrl}" alt="imagem">`;
      } else {
        mediaHtml = `<br><a href="${c.fileUrl}" target="_blank">üìé Abrir arquivo</a>`;
      }
    }

    div.innerHTML =
      `<b>${c.nome}</b> <small>${new Date(dt).toLocaleString()}</small><br>` +
      `${c.mensagem || ""}` +
      mediaHtml;

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

async function sendMessage(){
  if (!currentPinId) {
    alert("Clique em um pin primeiro");
    return;
  }

  const nome = document.getElementById("nome").value.trim();
  const msg  = document.getElementById("msg").value.trim();
  const link = document.getElementById("link").value.trim();

  if (!nome || (!msg && !link)) {
    alert("Preencha o nome e escreva uma mensagem ou cole um link.");
    return;
  }

  const body = new URLSearchParams({
    action: "addComment",
    pinId: currentPinId,
    nome: nome,
    mensagem: msg,
    fileUrl: link
  });

  await fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  document.getElementById("msg").value  = "";
  document.getElementById("link").value = "";

  await loadComments(currentPinId);
}

/* ---------- CHAT GERAL ---------- */

async function loadGlobal(){
  const r = await fetch(API_URL + "?action=getGlobal");
  const data = await r.json();

  const box = document.getElementById("global-messages");
  box.innerHTML = "";

  (data.messages || []).forEach(c => {
    const div = document.createElement("div");
    const dt = new Date(c.createdAt);

    div.className = "msg-block";

    let mediaHtml = "";
    if (c.fileUrl) {
      const clean = c.fileUrl.split("?")[0].toLowerCase();
      if (clean.endsWith(".png") || clean.endsWith(".jpg") || clean.endsWith(".jpeg") ||
          clean.endsWith(".gif") || clean.endsWith(".webp")) {
        mediaHtml = `<br><img src="${c.fileUrl}" alt="imagem">`;
      } else {
        mediaHtml = `<br><a href="${c.fileUrl}" target="_blank">üìé Abrir arquivo</a>`;
      }
    }

    div.innerHTML =
      `<b>${c.nome}</b> <small>${new Date(dt).toLocaleString()}</small><br>` +
      `${c.mensagem || ""}` +
      mediaHtml;

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

async function sendGlobal(){
  const nome = document.getElementById("g-nome").value.trim();
  const msg  = document.getElementById("g-msg").value.trim();
  const link = document.getElementById("g-link").value.trim();

  if (!nome || (!msg && !link)) {
    alert("Preencha o nome e escreva uma mensagem ou cole um link.");
    return;
  }

  const body = new URLSearchParams({
    action: "addGlobal",
    nome: nome,
    mensagem: msg,
    fileUrl: link
  });

  await fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  document.getElementById("g-msg").value  = "";
  document.getElementById("g-link").value = "";

  await loadGlobal();
}
</script>

</body>
</html>
