<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mapa Cient√≠fico Colaborativo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
*{
  box-sizing:border-box;
}
body{
  margin:0;
  font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
  background:linear-gradient(135deg,#0f172a,#0369a1);
  color:#0f172a;
}

/* CONTAINER GERAL */
#page{
  max-width:1400px;
  margin:0 auto;
}

/* BOT√ÉO PARA ESCONDER/MOSTRAR TOPO */
#toggle-header{
  position:fixed;
  top:6px;
  right:10px;
  z-index:1100;
  background:rgba(15,23,42,0.9);
  color:#e5e7eb;
  border:none;
  border-radius:999px;
  padding:4px 10px;
  font-size:11px;
  cursor:pointer;
}
#toggle-header:hover{
  background:rgba(30,64,175,0.95);
}

/* TOPO */
header{
  margin:10px 10px 0 10px;
  background:rgba(255,255,255,0.96);
  border-radius:14px;
  padding:10px 14px;
  box-shadow:0 6px 20px rgba(15,23,42,0.35);
  display:flex;
  gap:12px;
  align-items:flex-start;
}

header-left{
  display:block;
  flex:1.8;
}

header-right{
  display:block;
  flex:1.2;
}

/* T√≠tulo */
#logo-title{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:2px;
}
#logo-title span.icon{
  font-size:22px;
}
#logo-title h1{
  margin:0;
  font-size:20px;
  font-weight:700;
  letter-spacing:0.02em;
}
header-left p{
  margin:2px 0 2px 0;
  font-size:12px;
  color:#334155;
}

/* Chips / etiquetas (mais discretas) */
.chips{
  margin-top:2px;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:4px;
  font-size:10px;
  padding:3px 7px;
  border-radius:999px;
  background:#e0f2fe;
  color:#075985;
  margin-right:4px;
}

/* Card "Como participar" (compacto) */
#steps-card{
  background:#020617;
  color:#e5e7eb;
  border-radius:10px;
  padding:8px 10px;
  font-size:11px;
}
#steps-card h3{
  margin:0 0 4px 0;
  font-size:12px;
}
#steps-card ol{
  padding-left:16px;
  margin:2px 0 6px 0;
}
#steps-card li{
  margin-bottom:1px;
}
.legend-row{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:10px;
}
.legend-badge{
  width:7px;
  height:7px;
  border-radius:999px;
  background:#38bdf8;
}
.legend-badge.global{
  background:#a855f7;
}

/* LAYOUT MAPA + LATERAL */
#layout{
  display:flex;
  height:calc(100vh - 110px);
  margin:10px;
  gap:10px;
}

/* MAPA √Ä ESQUERDA */
#map-wrapper{
  flex:2;
  background:#020617;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(15,23,42,0.6);
  position:relative;
}
#map{
  height:100%;
}

/* TAG NO CANTO DO MAPA */
#map-tag{
  position:absolute;
  top:8px;
  left:12px;
  z-index:600;
  background:rgba(15,23,42,0.8);
  color:#e5e7eb;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
}

/* BOT√ÉO ESCONDER/MOSTRAR CHATS */
#toggle-sidebar{
  position:absolute;
  top:8px;
  right:12px;
  z-index:600;
  background:rgba(15,23,42,0.9);
  color:#e5e7eb;
  border:none;
  border-radius:999px;
  padding:4px 10px;
  font-size:11px;
  cursor:pointer;
}
#toggle-sidebar:hover{
  background:rgba(30,64,175,0.95);
}

/* LATERAL √Ä DIREITA */
#sidebar{
  flex:1.1;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* CART√ïES DE CHAT */
.panel{
  background:rgba(248,250,252,0.97);
  border-radius:14px;
  box-shadow:0 10px 30px rgba(15,23,42,0.45);
  padding:10px 10px;
  display:flex;
  flex-direction:column;
  height:50%;
  min-height:0;
  border:1px solid rgba(148,163,184,0.6);
}

.panel h3{
  margin:2px 0 4px 0;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:6px;
}
.panel h3 span.small{
  font-size:12px;
  font-weight:400;
  color:#64748b;
}

.subtitle{
  font-size:11px;
  color:#64748b;
  margin-bottom:6px;
}

/* √ÅREAS DE MENSAGENS */
#messages, #global-messages{
  border:1px solid #e2e8f0;
  border-radius:8px;
  padding:6px;
  margin-bottom:6px;
  flex:1;
  overflow-y:auto;
  background:#f9fafb;
}

.msg-block{
  border-bottom:1px solid #e5e7eb;
  margin-bottom:4px;
  padding-bottom:4px;
  font-size:12px;
}
.msg-block:last-child{
  border-bottom:none;
}

/* CAMPOS E BOT√ïES */
input, button{
  padding:6px;
  font-size:12px;
}
.controls, .global-controls{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.controls input, .global-controls input{
  flex:1;
  min-width:0;
}
button{
  border:none;
  border-radius:6px;
  background:#0f766e;
  color:white;
  cursor:pointer;
  padding:6px 10px;
  white-space:nowrap;
  font-weight:500;
  box-shadow:0 1px 2px rgba(15,23,42,0.25);
}
button:hover{
  background:#115e59;
}
button.secondary{
  background:#6366f1;
}
button.secondary:hover{
  background:#4f46e5;
}

/* RESPONSIVO */
@media (max-width:950px){
  #layout{
    flex-direction:column;
    height:auto;
  }
  #map-wrapper{
    height:45vh;
  }
  #sidebar{
    height:auto;
  }
}
</style>
</head>

<body>

<button id="toggle-header" onclick="toggleHeader()">‚Æù esconder topo</button>

<div id="page">

  <!-- TOPO / IDENTIDADE (compacto) -->
  <header id="top-header">
    <header-left>
      <div id="logo-title">
        <span class="icon">üß≠</span>
        <h1>Mapa Cient√≠fico Colaborativo</h1>
      </div>
      <p>
        Marque no mapa onde existem pesquisas, projetos e grupos de estudo.
        Cada ponto tem um chat pr√≥prio para combinar atividades e registrar observa√ß√µes.
      </p>
      <div class="chips">
        <span class="chip">Pesquisas em andamento</span>
        <span class="chip">Projetos de extens√£o e ensino</span>
        <span class="chip">Rede entre estudantes e docentes</span>
      </div>
    </header-left>

    <header-right>
      <div id="steps-card">
        <h3>Como participar</h3>
        <ol>
          <li>Clique no mapa para marcar o local.</li>
          <li>Preencha seu nome e o t√≠tulo do estudo.</li>
          <li>Use o chat do ponto para falar daquele lugar.</li>
          <li>Use o chat geral para recados da rede.</li>
        </ol>
        <div class="legend-row">
          <span class="legend-badge"></span> <span>Pins e conversas por local</span>
        </div>
        <div class="legend-row" style="margin-top:2px;">
          <span class="legend-badge global"></span> <span>Chat geral de toda a comunidade</span>
        </div>
      </div>
    </header-right>
  </header>

  <!-- MAPA + LATERAL -->
  <div id="layout">
    <div id="map-wrapper">
      <div id="map-tag">Clique no mapa para cadastrar uma pesquisa nesse local</div>
      <button id="toggle-sidebar" onclick="toggleSidebar()">‚Æú esconder chats</button>
      <div id="map"></div>
    </div>

    <div id="sidebar">
      <!-- CHAT DO PONTO -->
      <div id="pin-chat" class="panel">
        <h3>üí¨ Chat do ponto <span id="chat-title-extra" class="small">(nenhum ponto selecionado)</span></h3>
        <div class="subtitle" id="chat-subtitle">
          Selecione um pin no mapa ou crie um novo. Aqui aparecem as conversas ligadas a um local espec√≠fico.
        </div>
        <div id="messages"></div>
        
        <div class="controls">
          <input id="nome" placeholder="Seu nome">
          <input id="msg" placeholder="Mensagem (relatos, d√∫vidas, observa√ß√µes de campo...)">
          <button onclick="sendMessage()">Enviar</button>
        </div>
      </div>

      <!-- CHAT GERAL -->
      <div id="global-chat" class="panel">
        <h3>üåê Chat geral <span class="small">da rede cient√≠fica</span></h3>
        <div class="subtitle">
          Espa√ßo aberto para todos. Use para recados coletivos, avisos de eventos, d√∫vidas gerais e articula√ß√µes.
        </div>
        <div id="global-messages"></div>
        <div class="global-controls">
          <input id="g-nome" placeholder="Seu nome">
          <input id="g-msg" placeholder="Mensagem para toda a rede">
          <button onclick="sendGlobal()">Enviar</button>
          <button class="secondary" onclick="loadGlobal()">Atualizar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// URL DA API (Apps Script)
const API_URL = "https://script.google.com/macros/s/AKfycbwCutn7t2piEqfqk_I1RvjostsIWBojIFkQfWIGS1vMryFLAILqpIl44kXxMmxWHMIN/exec";

const map = L.map('map').setView([-15.6,-56.1],4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18
}).addTo(map);

let currentPinId = null;

// carrega pins e chat geral ao abrir
loadPins();
loadGlobal();

/* ---------- MAPA E PINS ---------- */

map.on('click', async function(e){
  const nome = prompt("Seu nome:");
  if(!nome) return;

  const titulo = prompt("T√≠tulo da pesquisa ou atividade nesse local:");
  if(!titulo) return;

  const body = new URLSearchParams({
    action: 'addPin',
    lat: e.latlng.lat,
    lng: e.latlng.lng,
    nome,
    titulo,
    mensagem: ""
  });

  const r = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  const pin = await r.json();
  addMarker(pin);
});

async function loadPins(){
  const r = await fetch(API_URL + "?action=listPins");
  const data = await r.json();
  (data.pins || []).forEach(addMarker);
}

function addMarker(pin){
  const m = L.marker([pin.lat, pin.lng]).addTo(map);
  m.bindPopup(`<b>${pin.titulo}</b><br>por ${pin.nome}<br><small>Clique para abrir o chat desse local</small>`);
  m.on("click", ()=> openChat(pin));
}

/* ---------- CHAT DO PIN ---------- */

async function openChat(pin){
  currentPinId = pin.id;
  document.getElementById("chat-title-extra").innerText =
    `‚Äî ${pin.titulo} (por ${pin.nome})`;
  document.getElementById("chat-subtitle").innerText =
    "Conversas ligadas a este local. Use para discutir resultados, log√≠stica, observa√ß√µes de campo e ideias.";
  await loadComments(pin.id);
}

async function loadComments(pinId){
  const r = await fetch(API_URL + "?action=getComments&pinId=" + encodeURIComponent(pinId));
  const data = await r.json();

  const box = document.getElementById("messages");
  box.innerHTML = "";

  (data.comments || []).forEach(c => {
    const div = document.createElement("div");
    const dt = new Date(c.createdAt);

    div.className = "msg-block";

    div.innerHTML =
      `<b>${c.nome}</b> <small>${new Date(dt).toLocaleString()}</small><br>` +
      `${c.mensagem || ""}`;

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

async function sendMessage(){
  if (!currentPinId) {
    alert("Clique em um pin primeiro para enviar mensagem no chat do ponto.");
    return;
  }

  const nome = document.getElementById("nome").value.trim();
  const msg  = document.getElementById("msg").value.trim();

  if (!nome || !msg) {
    alert("Preencha o nome e escreva uma mensagem.");
    return;
  }

  const body = new URLSearchParams({
    action: "addComment",
    pinId: currentPinId,
    nome: nome,
    mensagem: msg
  });

  await fetch(API_URL, {
    method: "POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  document.getElementById("msg").value  = "";

  await loadComments(currentPinId);
}

/* ---------- CHAT GERAL ---------- */

async function loadGlobal(){
  const r = await fetch(API_URL + "?action=getGlobal");
  const data = await r.json();

  const box = document.getElementById("global-messages");
  box.innerHTML = "";

  (data.messages || []).forEach(c => {
    const div = document.createElement("div");
    const dt = new Date(c.createdAt);

    div.className = "msg-block";

    div.innerHTML =
      `<b>${c.nome}</b> <small>${new Date(dt).toLocaleString()}</small><br>` +
      `${c.mensagem || ""}`;

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

async function sendGlobal(){
  const nome = document.getElementById("g-nome").value.trim();
  const msg  = document.getElementById("g-msg").value.trim();

  if (!nome || !msg) {
    alert("Preencha o nome e a mensagem.");
    return;
  }

  const body = new URLSearchParams({
    action: "addGlobal",
    nome: nome,
    mensagem: msg
  });

  await fetch(API_URL, {
    method: "POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  document.getElementById("g-msg").value  = "";

  await loadGlobal();
}

/* ---------- ESCONDER / MOSTRAR LATERAL ---------- */
function toggleSidebar(){
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('toggle-sidebar');
  const isHidden = sidebar.style.display === 'none';

  if (isHidden){
    sidebar.style.display = 'flex';
    btn.textContent = '‚Æú esconder chats';
  } else {
    sidebar.style.display = 'none';
    btn.textContent = '‚Æû mostrar chats';
  }

  setTimeout(() => {
    map.invalidateSize();
  }, 300);
}

/* ---------- ESCONDER / MOSTRAR TOPO ---------- */
function toggleHeader(){
  const header = document.getElementById('top-header');
  const layout = document.getElementById('layout');
  const btn = document.getElementById('toggle-header');
  const isHidden = header.style.display === 'none';

  if (isHidden){
    header.style.display = 'flex';
    layout.style.height = 'calc(100vh - 110px)';
    btn.textContent = '‚Æù esconder topo';
  } else {
    header.style.display = 'none';
    layout.style.height = 'calc(100vh - 20px)';
    btn.textContent = '‚Æü mostrar topo';
  }

  setTimeout(() => {
    map.invalidateSize();
  }, 300);
}
</script>

</body>
</html>
