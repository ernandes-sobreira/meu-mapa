<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Meu Mapa Compartilhado</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:Arial;
}
#map{
  height:65vh;
}
#chat{
  display:none;
  border-top:2px solid #ccc;
  padding:8px;
  background:#fafafa;
  height:35vh;
  overflow-y:auto;
}
#messages{
  border:1px solid #ddd;
  padding:6px;
  margin-bottom:6px;
  max-height:18vh;
  overflow-y:auto;
}
input, button{
  padding:6px;
  font-size:14px;
}
.controls{
  display:flex;
  gap:4px;
  flex-wrap:wrap;
}
.controls input{
  flex:1;
}
</style>
</head>

<body>

<h2 style="text-align:center">üåç Meu Mapa Colaborativo</h2>
<p style="text-align:center">Clique no mapa para criar um pin. Clique em um pin para conversar.</p>

<div id="map"></div>

<div id="chat">
  <h3 id="chat-title"></h3>
  <div id="messages"></div>
  
  <div class="controls">
  <input id="nome" placeholder="Seu nome">
  <input id="msg" placeholder="Mensagem">

  <input type="file" id="file"
         accept="image/*,.pdf">

  <button onclick="sendMessage()">Enviar</button>
</div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwvKy33oOkQEaLNMCTc5H9U69OjnkF1O35TSVDfuIGKOQ7KAdt28G3TRdagFFPdFCxG/exec";

const map = L.map('map').setView([-15.6,-56.1],4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
 maxZoom:18
}).addTo(map);

let currentPinId = null;

// carregar pins salvos
loadPins();

map.on('click', async function(e){

  const nome = prompt("Seu nome:");
  if(!nome) return;

  const titulo = prompt("T√≠tulo do ponto:");
  if(!titulo) return;

  const mensagem = prompt("Mensagem inicial (opcional):") || "";

  const body = new URLSearchParams({
    action: 'addPin',
    lat: e.latlng.lat,
    lng: e.latlng.lng,
    nome,
    titulo,
    mensagem
  });

  const r = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  const pin = await r.json();
  addMarker(pin);
});

async function loadPins(){
  const r = await fetch(API_URL + "?action=listPins");
  const data = await r.json();
  data.pins.forEach(addMarker);
}

function addMarker(pin){
  const marker = L.marker([pin.lat, pin.lng]).addTo(map);

  marker.bindPopup(`<b>${pin.titulo}</b><br>por ${pin.nome}<br><small>Clique para abrir o chat</small>`);

  marker.on("click",()=>{
    openChat(pin);
  });
}

async function openChat(pin){
  currentPinId = pin.id;

  document.getElementById("chat").style.display = "block";
  document.getElementById("chat-title").innerText =
    pin.titulo + " ‚Äî " + pin.nome;

  loadComments(pin.id);
}

async function loadComments(pinId){
  const r = await fetch(API_URL+"?action=getComments&pinId="+pinId);
  const data = await r.json();

  const box = document.getElementById("messages");
  box.innerHTML="";

  data.comments.forEach(c=>{
    const div = document.createElement("div");
    const dt = new Date(c.createdAt);

    div.style.borderBottom="1px solid #eee";
    div.style.marginBottom="4px";
    div.innerHTML =
      `<b>${c.nome}</b> <small>${dt.toLocaleString()}</small><br>${c.mensagem}`;

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

async function sendMessage(){
  if(!currentPinId){
    alert("Clique em um pin primeiro");
    return;
  }

  const nome = document.getElementById("nome").value.trim();
  const msg  = document.getElementById("msg").value.trim();
  const file = document.getElementById("file").files[0];

  if(!nome || (!msg && !file)){
    alert("Preencha nome e mensagem ou anexe um arquivo");
    return;
  }

  // bloquear v√≠deo
  if(file && file.type.startsWith("video/")){
    alert("V√≠deos n√£o s√£o permitidos.");
    document.getElementById("file").value="";
    return;
  }

  const params = {
    action: "addComment",
    pinId: currentPinId,
    nome: nome,
    mensagem: msg
  };

  // se houver arquivo
  if(file){
    const base64 = await toBase64(file);
    params.file = base64.split(",")[1];
    params.fileName = file.name;
    params.mimeType = file.type;
  }

  const body = new URLSearchParams(params);

  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  document.getElementById("msg").value="";
  document.getElementById("file").value="";

  loadComments(currentPinId);
}

function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

</script>

</body>
</html>
