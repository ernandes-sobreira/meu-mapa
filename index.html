<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Meu Mapa Compartilhado</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:Arial;
}
h2,h3{
  margin:8px 0;
}
#map{
  height:50vh;
}

/* Chat por PIN */
#chat{
  display:none;
  border-top:2px solid #ccc;
  padding:8px;
  background:#fafafa;
  max-height:30vh;
  overflow-y:auto;
  margin-bottom:8px;
}
#messages{
  border:1px solid #ddd;
  padding:6px;
  margin-bottom:6px;
  max-height:18vh;
  overflow-y:auto;
}

/* Chat geral */
#global-chat{
  border-top:2px solid #999;
  padding:8px;
  background:#f0f0f0;
  max-height:35vh;
  overflow-y:auto;
}
#global-messages{
  border:1px solid #ccc;
  padding:6px;
  margin-bottom:6px;
  max-height:22vh;
  overflow-y:auto;
}

input, button{
  padding:6px;
  font-size:14px;
}
.controls, .global-controls{
  display:flex;
  gap:4px;
  flex-wrap:wrap;
}
.controls input, .global-controls input{
  flex:1;
}

.msg-block{
  border-bottom:1px solid #eee;
  margin-bottom:4px;
  padding-bottom:4px;
}
.msg-block img{
  max-width:100%;
  max-height:180px;
  border-radius:6px;
  margin-top:4px;
}
</style>
</head>

<body>

<h2 style="text-align:center">üåç Meu Mapa Colaborativo</h2>
<p style="text-align:center">
  Clique no mapa para criar um pin. Clique em um pin para abrir o chat daquele local.<br>
  Para imagens, cole o link (ex: PNG/JPG). Imagens aparecem dentro da mensagem.
</p>

<div id="map"></div>

<!-- CHAT POR PIN -->
<div id="chat">
  <h3 id="chat-title"></h3>
  <div id="messages"></div>
  
  <div class="controls">
    <input id="nome" placeholder="Seu nome">
    <input id="msg" placeholder="Mensagem">
    <input id="link" placeholder="Link de imagem ou arquivo (opcional)">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<!-- CHAT GERAL -->
<div id="global-chat">
  <h3>üí¨ Chat geral</h3>
  <div id="global-messages"></div>
  <div class="global-controls">
    <input id="g-nome" placeholder="Seu nome">
    <input id="g-msg" placeholder="Mensagem">
    <input id="g-link" placeholder="Link de imagem ou arquivo (opcional)">
    <button onclick="sendGlobal()">Enviar</button>
    <button onclick="loadGlobal()">Atualizar</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwvKy33oOkQEaLNMCTc5H9U69OjnkF1O35TSVDfuIGKOQ7KAdt28G3TRdagFFPdFCxG/exec";

const map = L.map('map').setView([-15.6,-56.1],4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18
}).addTo(map);

let currentPinId = null;

// carrega pins e chat geral ao abrir
loadPins();
loadGlobal();

// -------- MAPA E PINS --------

map.on('click', async function(e){
  const nome = prompt("Seu nome:");
  if(!nome) return;

  const titulo = prompt("T√≠tulo do ponto:");
  if(!titulo) return;

  const mensagem = prompt("Mensagem inicial (opcional):") || "";

  const body = new URLSearchParams({
    action: 'addPin',
    lat: e.latlng.lat,
    lng: e.latlng.lng,
    nome,
    titulo,
    mensagem
  });

  const r = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  const pin = await r.json();
  addMarker(pin);
});

async function loadPins(){
  const r = await fetch(API_URL + "?action=listPins");
  const data = await r.json();
  (data.pins || []).forEach(addMarker);
}

function addMarker(pin){
  const m = L.marker([pin.lat, pin.lng]).addTo(map);
  m.bindPopup(`<b>${pin.titulo}</b><br>por ${pin.nome}<br><small>Clique para abrir o chat</small>`);
  m.on("click", ()=> openChat(pin));
}

// -------- CHAT POR PIN --------

async function openChat(pin){
  currentPinId = pin.id;
  document.getElementById("chat").style.display = "block";
  document.getElementById("chat-title").innerText =
    pin.titulo + " ‚Äî " + pin.nome;
  await loadComments(pin.id);
}

async function loadComments(pinId){
  const r = await fetch(API_URL + "?action=getComments&pinId=" + encodeURIComponent(pinId));
  const data = await r.json();

  const box = document.getElementById("messages");
  box.innerHTML = "";

  (data.comments || []).forEach(c => {
    const div = document.createElement("div");
    const dt = new Date(c.createdAt);

    div.className = "msg-block";

    let mediaHtml = "";
    if (c.fileUrl) {
      const clean = c.fileUrl.split("?")[0].toLowerCase();
      if (clean.endsWith(".png") || clean.endsWith(".jpg") || clean.endsWith(".jpeg") ||
          clean.endsWith(".gif") || clean.endsWith(".webp")) {
        mediaHtml = `<br><img src="${c.fileUrl}" alt="imagem">`;
      } else {
        mediaHtml = `<br><a href="${c.fileUrl}" target="_blank">üìé Abrir arquivo</a>`;
      }
    }

    div.innerHTML =
      `<b>${c.nome}</b> <small>${new Date(dt).toLocaleString()}</small><br>` +
      `${c.mensagem || ""}` +
      mediaHtml;

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

async function sendMessage(){
  if (!currentPinId) {
    alert("Clique em um pin primeiro");
    return;
  }

  const nome = document.getElementById("nome").value.trim();
  const msg  = document.getElementById("msg").value.trim();
  const link = document.getElementById("link").value.trim();

  if (!nome || (!msg && !link)) {
    alert("Preencha o nome e escreva uma mensagem ou cole um link.");
    return;
  }

  const body = new URLSearchParams({
    action: "addComment",
    pinId: currentPinId,
    nome: nome,
    mensagem: msg,
    fileUrl: link
  });

  await fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  document.getElementById("msg").value  = "";
  document.getElementById("link").value = "";

  await loadComments(currentPinId);
}

// -------- CHAT GERAL --------

async function loadGlobal(){
  const r = await fetch(API_URL + "?action=getGlobal");
  const data = await r.json();

  const box = document.getElementById("global-messages");
  box.innerHTML = "";

  (data.messages || []).forEach(c => {
    const div = document.createElement("div");
    const dt = new Date(c.createdAt);

    div.className = "msg-block";

    let mediaHtml = "";
    if (c.fileUrl) {
      const clean = c.fileUrl.split("?")[0].toLowerCase();
      if (clean.endsWith(".png") || clean.endsWith(".jpg") || clean.endsWith(".jpeg") ||
          clean.endsWith(".gif") || clean.endsWith(".webp")) {
        mediaHtml = `<br><img src="${c.fileUrl}" alt="imagem">`;
      } else {
        mediaHtml = `<br><a href="${c.fileUrl}" target="_blank">üìé Abrir arquivo</a>`;
      }
    }

    div.innerHTML =
      `<b>${c.nome}</b> <small>${new Date(dt).toLocaleString()}</small><br>` +
      `${c.mensagem || ""}` +
      mediaHtml;

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

async function sendGlobal(){
  const nome = document.getElementById("g-nome").value.trim();
  const msg  = document.getElementById("g-msg").value.trim();
  const link = document.getElementById("g-link").value.trim();

  if (!nome || (!msg && !link)) {
    alert("Preencha o nome e escreva uma mensagem ou cole um link.");
    return;
  }

  const body = new URLSearchParams({
    action: "addGlobal",
    nome: nome,
    mensagem: msg,
    fileUrl: link
  });

  await fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body
  });

  document.getElementById("g-msg").value  = "";
  document.getElementById("g-link").value = "";

  await loadGlobal();
}
</script>

</body>
</html>
